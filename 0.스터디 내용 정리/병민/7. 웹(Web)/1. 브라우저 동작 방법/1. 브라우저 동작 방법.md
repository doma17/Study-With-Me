# 브라우저 동작 방법

브라우저는 무엇일까요? 브라우저는 웹사이트를 검색하고 표시하는 데에 사용되는 소프트웨어 프로그램입니다.
다양한 프로그램들이 있지만, 대표적으로 크롬, 엣지, 사파리, 브레이브 등 크로미움 기반의 브라우저들이 많이 쓰입니다.

우리(개발자)는 왜 브라우저의 동작 방법에 대해서 알아야 할까요?

사용자는 느린, 상호작용이 어려운 컨텐츠에 대한 경험을 매우 싫어합니다. UX가 나쁜거죠.
구글 리서치 자료에 따르면 웹 사이트의 로딩 시간이 3초 이상 일 때 32%, 5초 이상은 90% .. 로 대부분의 유저들이 이탈한다고 합니다.

<img src="https://websitesetup.org/wp-content/themes/vws-wsu-bs-starter/static-pages/fast-enough/img/the-effect-of-page-load-time-increase-on-bounce-rate.jpg" style="max-width:40%; height:auto;" />

따라서 우리는 제 성능 및 체감되는 성능을 향상시키는 방법을 이해하기 위해서 웹 브라우저의 동작 방법을 알고 있어야 합니다.

## 브라우저의 역할

1. HTML, JS, CSS를 언어 해석 -> 렌더링
2. 웹페이지 표시, 주소 입력, 검색, 북마크, 검색 등 웹사이트 기반 편리성 기능 제공

위와 같은 역할들은 브라우저는 책임 지고 있습니다.

또한, 아래와 같은 과정들을 토대로 웹 페이지를 로딩하는데요.
하나씩 목차를 따라가보면서 살펴보겠습니다.

## 1. Navigation - 탐색

탐색(Navigation) 은 웹페이지를 로딩하는 첫 단계입니다. 사용자가 주소창에 URL을 입력하거나, 링크를 클릭하고, 폼(form)을 제출하는 등의 동작을 통해 요청을 보낼 때마다 발생합니다.

웹 최적화의 목표 중 하나는 **탐색이 완료될 때까지의 시간을 최소화** 하는 것입니다. 이상적인 조건에서 그다지 오래 걸리는 작업이 아니지만 지연시간과 대역폭은 지연을 일으키는 적입니다.

### 1-1. DNS Lookup - DNS 조회

우리는 Domain Name으로 사이트를 조회합니다.
만약 이 사이트를 한 번도 방문한 적이 없다면 이러한 Domain Name을 통해 실제 서버의 IP을 알아내기 위해서 DNS 조회를 실행하게 됩니다.

<img src="https://www.indusface.com/wp-content/uploads/2024/10/DNS-lookup-process-.png" style="max-width:80%; height:auto;" />

### 1-2. TCP Handshake - TCP 핸드셰이크

IP를 알아내고 난 뒤에 브라우저와 서버는 TCP 3-way handshake를 통해 연결을 수립합니다.

<img src="https://unicminds.com/wp-content/uploads/2024/03/TCPIP-Handshake.webp" style="max-width:50%; height:auto;" />

SYN, SYN-ACK, ACK를 통해 3개의 메세지를 통해서 TCP 소켓 연결을 위한 매개변수를 주고 받습니다.

### 1-3. TLS Negotiation - TLS 협상

HTTPS를 이용한 보안성있는 연결을 위해서는 또 다른 "핸드셰이크"가 필요합니다.

<img src="https://developer.mozilla.org/ko/docs/Web/Performance/Guides/How_browsers_work/ssl.jpg" style="max-width:80%; height:auto;" />

연결에 보안성을 더하는 것은 페이지 로딩을 더디게 합니다. 
하지만 보안성있는 연결은 지연시간이라는 비용을 낼만큼 충분히 가치가 있습니다. 
브라우저와 웹서버 사이에 전송되는 데이터가 제 3자에 의해서 해독될 수 없게 되기 때문입니다.

결국에 8번의 왕복이 있은 후에, 브라우저는 마침내 요청을 할 수 있습니다.

## 2. Response - 응답

웹서버로 한 번 연결이 성립되고 나면, 브라우저는 유저 대신에 초기 HTTP GET request를 보냅니다. 웹사이트는 대게 HTML 파일을 요청합니다. 서버가 요청을 받으면, 관련 응답 해더와 함께 HTML의 내용을 응답하게 됩니다.

```html
<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>My simple page</title>
    <link rel="stylesheet" src="styles.css" />
    <script src="myscript.js"></script>
  </head>
  <body>
    <h1 class="heading">My Page</h1>
    <p>A paragraph with a <a href="https://example.com/about">link</a></p>
    <div>
      <img src="myimage.jpg" alt="image description" />
    </div>
    <script src="anotherscript.js"></script>
  </body>
</html>
```

### 2-1. Congestion Control / TCP Slow Start

TCP 패킷은 전송 중에 세그먼트로 분할됩니다. TCP는 패킷의 순서를 보장하기 때문에 서버는 일정 개수의 세그먼트를 전송한 후 클라이언트로부터 ACK 패킷 형태로 승인을 받아야 합니다.

서버가 각 세그먼트마다 ACK을 기다린다면 클라이언트로부터 빈번한 ACK이 발생하고, 이는 저부하 네트워크 상황에서도 전송 시간을 증가시킬 수 있습니다.

반면, 한 번에 너무 많은 세그먼트를 보내면 사용량이 많은 네트워크는 클라이언트가 세그먼트를 받을 수 없어 계속 ACK만 응답하게 되고, 서버는 세그먼트를 계속 재전송해야 하는 문제가 발생할 수 있습니다.

<img src="https://www.researchgate.net/publication/332436793/figure/fig1/AS:1128789102870528@1646135702126/TCP-Slow-Start-and-Congestion-Avoidance-phase.ppm" style="max-width:80%; height:auto;" />

전송되는 세그먼트 수의 균형을 맞추기 위해 TCP 슬로우 스타트 알고리즘을 사용하여 최대 네트워크 대역폭이 결정될 때까지 전송되는 데이터의 양을 점차적으로 늘리고 네트워크 부하가 높은 경우 전송되는 데이터의 양을 줄입니다.

## 3. Parsing - 구문 분석

브라우저가 첫 번째 데이터의 청크를 받으면, 수신된 정보를 구문 분석하기 시작합니다.
구문 분석은 브라우저가 네트워크를 통해 받은 데이터를 DOM(Document Object Model)이나 CSSOM(CSS Object Model)으로 바꾸는 단계입니다. 
이는 렌더러가 화면에 페이지를 그리는데 사용됩니다.

요청된 HTML 페이지의 크기가 초기 패킷의 크기인 14kb 보다 크더라도, 브라우저는 구문 분석을 시작하고 가지고 있는 데이터 수준에서 렌더링을 시도합니다.
이것이 웹 성능 최적화에서 브라우저가 페이지를 렌더링 하는데 필요한 모든 것, 아니면 적어도 페이지의 템플릿(첫 렌더링에 필요한 HTML이나 CSS)만이라도 첫 14kb에 포함해야하는 이유입니다. 
하지만 화면에 렌더링하기 전에 HTML, CSS, Javascript를 구문 분석해야 합니다.

### 3-1. Build DOM Tree - DOM 트리 구축

첫 단계는 HTML을 처리하여 DOM 트리를 만드는 것입니다. 
HTML 구문 분석은 토큰화와 트리 생성을 포함합니다. 
HTML 토큰은 시작 및 종료 태그 그리고 속성 이름 및 값을 포함합니다. 
만약 문서가 잘 구성되어 있다면 구문 분석은 명확하고 빠르게 이루어집니다. 
구문 분석기는 토큰화된 입력을 분석하여 DOM 트리를 만듭니다.

트리는 다른 태그간의 관계와 계층을 반영합니다. 다른 태그에 감싸져 있는 태그는 자식 노드입니다. 
DOM 노드의 개수가 많아질수록, DOM 트리를 만드는데 더 오랜 시간이 걸립니다.

<img src="https://developer.mozilla.org/ko/docs/Web/Performance/Guides/How_browsers_work/dom.gif" style="max-width:80%; height:auto;" />

구문 분석기가 이미지와 같은 논 블로킹 자원을 발견하면, 브라우저는 해당 자원을 요청하고 분석을 계속합니다. 구문 분석은 CSS 파일을 만났을 때도 지속될 수 있습니다.
하지만 async나 defer 같은 설정이 되어있지 않은 <script> 태그는 렌더링을 막고, HTML의 분석을 중지시킵니다. 
브라우저의 프리로드 스캐너가 이 작업을 가속화하지만, 과도한 스크립트는 여전히 주요한 병목구간이 될 수 있습니다.

### 3-2. Preload Scanner - 프리로드 스캐너

브라우저가 DOM 트리를 만드는 프로세스는 메인 쓰레드를 차지합니다. 
그렇기 때문에, 프리로드 스캐너 는 사용 가능한 컨텐츠를 분석하고 CSS나 Javscript, 웹 폰트 같이 우선순위가 높은 자원을 요청합니다. 
프리로드 스캐너 덕에 구문 분석기가 외부 자원에 대한 참조를 찾아 요청하기까지 기다리지 않아도 됩니다. 
프리로드 스캐너가 자원을 뒤에서 미리 요청합니다. 그래서 구문 분석기가 요청되는 자원에 다다를 때 쯤이면 이미 그 자원들을 전송받고 있거나 이미 전송받은 후일 것입니다. 
프리로드 스캐너가 제공하는 최적화는 블록킹을 줄여줍니다.

```html
<link rel="stylesheet" src="styles.css" />
<script src="myscript.js" async></script>
<img src="myimage.jpg" alt="image description" />
<script src="anotherscript.js" async></script>
```

### 3-3. Build CSSOM - CSSOM 구축

중요한 렌더링 경로에서 두 번째 단계는 CSS를 처리하고 CSSOM 트리를 만드는 것입니다.
CSS 객체 모델은 DOM과 비슷합니다. DOM과 CSSOM은 둘 다 트리구조입니다.
둘은 각각의 독립적인 자료구조 입니다. 브라우저는 CSS 규칙을 이해할 수 있고 작업을 진행할 수 있도록 스타일 맵으로 변환합니다. 
브라우저는 CSS에 있는 각각의 규칙을 읽고, 트리 노드를 만듭니다. 
CSS 선택자에 기반해서 부모 노드, 자식 노드, 형제 관계의 노드를 만들어집니다.

이외에도 다양한 작업들이 뒤에서 실행됩니다.

- Javascript 컴파일
- 접근성 트리 구축

## 4. Render - 렌더링

렌더링 과정에서는 스타일, 레이아웃, 페인트 그리고 때때로 합성이 포함됩니다.
CSSOM과 DOM 트리는 구문 분석되는 과정에서 생성되고 렌더 트리로 합성됩니다. 
렌더 트리는 보이는 요소의 레이아웃을 계산을 합니다. 그러고 나서 요소가 화면에 페인트됩니다. 
어떤 경우에는 컨텐츠가 자신만의 레이어를 가지도록 조작되고, 나중에 합성됩니다. 화면의 일부분을 CPU 대신 GPU가 그리면서 메인 쓰레드의 부담이 줄고 성능이 향상됩니다.

- 스타일
- 레이아웃
- 페인트
- 합성

위의 4단계로 렌더링됩니다. 자세한 내용은 별도로 공부해보시면 좋을 것 같습니다.

## 5. Interactivity - 상호작용

메인 쓰레드가 페이지를 그리는 것을 완료하면, 모든 것이 준비되었다고 생각할 수도 있습니다.
하지만 꼭 그렇지는 않습니다. 만약 지연된 Javascript를 다운했다면, 그리고 onload 이벤트가 발생할 때 코드가 실행된다면, 메인 쓰레드는 여전히 바쁠 것입니다. 
그래서 스크롤링, 터치 등 다른 상호작용이 불가능 할 것입니다.

Time to Interactive (TTI) 는 DNS 조회와 SSL 연결이 이루어지는 첫 요청부터 페이지가 상호작용할 준비가 될 때까지 얼마나 걸리는지를 측정하는 단위입니다. 
첫 번째 콘텐츠가 포함된 페인트 이후 페이지가 사용자와의 상호작용에 50ms 이내로 응답할 때를 상호작용 가능한 시점으로 봅니다. 
만약 메인 쓰레드가 구문 분석, 컴파일, Javascript 실행에 사용되고 있다면, 메인 쓰레드를 사용할 수 없고 따라서 사용자 상호작용에 50ms 이내로 적절하게 반응하지 못합니다.

![TTI-waterfall](https://developer.mozilla.org/ko/docs/Web/Performance/Guides/How_browsers_work/visa_network.png)

## 결론

생략된 과정들이 정말 많지만, 파보면 너무나 많은 작용으로 웹브라우저가 작동하는 것을 알 수 있습니다.

즉, 웹브라우저는 총 5단계로 동작합니다.

- 탐색
- 응답
- 구문분석
- 렌더
- 상호작용

이러한 브라우저 동작 과정에 대한 학습을 통해서 UX 향상의 인사이트를 얻을 수 있으면 좋겠습니다.

## Reference

- https://developer.mozilla.org/ko/docs/Web/Performance/Guides/How_browsers_work#%EA%B5%AC%EB%AC%B8_%EB%B6%84%EC%84%9Dparsing
- https://brunch.co.kr/@rightbrain/61
- 인프런 <밑바닥부터 시작하는 웹 브라우저>
  - https://www.inflearn.com/challenge/4%EC%A3%BC-%EA%B3%BC%EC%A0%95-lt%EB%B0%91%EB%B0%94%EB%8B%A5%EB%B6%80%ED%84%B0-%EC%8B%9C%EC%9E%91%ED%95%98%EB%8A%94-%EC%9B%B9