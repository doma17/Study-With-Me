# OAuth

간단히 말하면 '권한 위임' 표준입니다.
서비스 A가 사용자 대신 서비스 B에 있는 자원에 접근할 때, 사용자가 직접 ID/PW를 제공하지 않고 안전하게 허가를 부여하는 방법을 정리합니다.

## OAuth 구성 요소

- Resource Owner
  - 실제 사용자로서 자신의 데이터(예: 프로필, 사진 등)를 소유합니다.
- Client
  - 사용자 대신 자원에 접근하려는 애플리케이션(웹앱, 모바일앱 등)입니다.
- Authorization Server
  - 사용자 인증을 수행하고 토큰(authorization code, access token, refresh token 등)을 발급합니다.
- Resource Server
  - 실제 자원을 보유한 서버(Google, Kakao 등)로서 access token으로 요청을 허용합니다.
- Access Token
  - 자원 접근 권한을 증명하는 짧은 수명의 자격증명입니다.
- Refresh Token
  - access token이 만료되었을 때 재발급을 지원하는 비교적 긴 수명의 토큰입니다.

![OAuth-Flow](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FbaYmz0%2Fbtrm5yf1gRK%2FAAAAAAAAAAAAAAAAAAAAAOaFTMcopctkzWLdeSnqB4Ai13UrEqMA94pT1BAGNJJD%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1764514799%26allow_ip%3D%26allow_referer%3D%26signature%3DIIuIKDWL9udypqwKW97YuM4an%252Bw%253D)

## 왜 필요한가

- 사용자가 앱에 비밀번호를 직접 제공하지 않도록 하기 위해 필요합니다.
- 서비스 간 최소 권한만 부여하여 권한 범위를 제한하기 위해 필요합니다.
- 토큰 기반으로 권한 취소와 권한 범위 관리가 용이하기 때문에 필요합니다.

## 기본 흐름 (Authorization Code Grant) — 가장 많이 사용되는 흐름입니다

1. Client가 Authorization Server로 사용자의 동의를 요청하는 화면으로 리다이렉트합니다.
   - 예: GET https://auth.example.com/oauth/authorize?response_type=code&client_id=...&redirect_uri=...&scope=...
2. 사용자가 로그인하고 동의하면 Authorization Server는 redirect_uri로 authorization code를 전달합니다.
   - 예: https://client.app/callback?code=AUTH_CODE
3. Client는 받은 code를 Authorization Server에 보내 access token을 요청합니다.
   - POST https://auth.example.com/oauth/token
   - form: grant_type=authorization_code&code=AUTH_CODE&redirect_uri=...&client_id=...&client_secret=...
4. Authorization Server는 access token(및 refresh token)을 발급합니다.
5. Client는 access token을 Authorization 헤더에 넣어 Resource Server에 API 요청을 전송합니다.
   - Authorization: Bearer ACCESS_TOKEN

### curl 예시 (토큰 교환)

```bash
# code를 access token으로 교환
curl -X POST https://auth.example.com/oauth/token \
  -d 'grant_type=authorization_code' \
  -d 'code=AUTH_CODE' \
  -d 'redirect_uri=https://client.app/callback' \
  -u 'CLIENT_ID:CLIENT_SECRET'

# 받은 access_token으로 리소스 호출
curl -H "Authorization: Bearer <ACCESS_TOKEN>" https://api.resource.com/user/profile
```

## Refresh Token 사용

- access token은 보안상 짧게 설정합니다(예: 5분~1시간).
- refresh token은 상대적으로 길게 설정합니다.
- access token 만료 시 클라이언트는 refresh token으로 새로운 access token을 요청합니다.

```bash
curl -X POST https://auth.example.com/oauth/token \
  -d 'grant_type=refresh_token' \
  -d 'refresh_token=REFRESH_TOKEN' \
  -u 'CLIENT_ID:CLIENT_SECRET'
```

## Grant 타입

- Authorization Code
  - 서버사이드 웹 애플리케이션에 권장되는 방식입니다.
- Implicit
  - 브라우저에서 직접 토큰을 받는 방식으로 과거 SPA에 사용되었으나 보안상 권장하지 않습니다.
- Resource Owner Password Credentials
  - 사용자가 클라이언트에 ID/PW를 직접 제공하는 방식으로 신뢰할 수 있는 상황에서만 사용합니다.
- Client Credentials
  - 서버 대 서버 인증으로 사용자 개입이 없는 경우에 사용합니다.

## 요약 및 권장사항

- 항상 HTTPS를 사용합니다.
- 토큰은 필요한 최소 권한(scope)만 요청합니다.
- 토큰 저장은 브라우저에서는 HttpOnly 쿠키나 안전한 저장소를 사용하고 localStorage 사용은 XSS 위험 때문에 지양합니다.
- CORS 설정과 redirect URI 매핑을 정확히 구성합니다.
- refresh token은 가능한 서버 측에 보관합니다.
- 토큰 무효화(revocation) 엔드포인트가 있다면 연동하여 사용합니다.
