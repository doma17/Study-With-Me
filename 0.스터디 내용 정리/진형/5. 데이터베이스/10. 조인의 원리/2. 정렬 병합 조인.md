## 데이터베이스 조인 방식: 정렬 병합 조인 (Sort Merge Join)

**정렬 병합 조인(Sort Merge Join 또는 Merge Join)** 은 이름 그대로 두 테이블을 조인하기 전에 먼저 \*\*각각의 테이블을 조인할 컬럼 기준으로 정렬(Sort)\*\*하고, 정렬된 결과를 \*\*순차적으로 병합(Merge)\*\*하면서 조인 조건을 만족하는 데이터를 찾는 방식입니다.

이 조인 방식은 대용량 데이터를 처리할 때 중첩 루프 조인(Nested Loop Join)보다 훨씬 효율적일 수 있습니다.

---

### 1\. 동작 원리

정렬 병합 조인은 크게 두 단계로 나뉩니다.

#### 1단계: 정렬 (Sort Phase)

- 첫 번째 테이블과 두 번째 테이블을 각각 **조인에 사용할 컬럼을 기준으로 오름차순으로 정렬**합니다.
- 예를 들어 `EMP.DEPTNO`와 `DEPT.DEPTNO`를 기준으로 조인한다면, `EMP` 테이블은 `DEPTNO` 순으로, `DEPT` 테이블도 `DEPTNO` 순으로 미리 정렬합니다.
- 만약 조인 컬럼에 이미 인덱스가 생성되어 있다면, 별도의 정렬 과정을 생략할 수 있어 성능이 크게 향상됩니다.

#### 2단계: 병합 (Merge Phase)
---
- 정렬된 두 테이블을 마치 **두 개의 정렬된 리스트를 합치는 것처럼** 맨 위에서부터 한 행씩 비교를 시작합니다.
- **비교 로직**:
    1.  두 테이블의 포인터(현재 위치)를 각각 첫 번째 행에 둡니다.
    2.  두 테이블의 현재 행에서 조인 컬럼 값을 비교합니다.
        - **값이 같으면 (A = B)**: 조인에 성공한 것이므로 결과 집합에 추가하고, 두 테이블의 포인터를 모두 다음 행으로 이동시킵니다.
        - **값이 다르면 (A \< B)**: A 테이블의 포인터만 다음 행으로 이동시켜 B와 같은 값을 찾습니다.
        - **값이 다르면 (A \> B)**: B 테이블의 포인터만 다음 행으로 이동시켜 A와 같은 값을 찾습니다.
    3.  두 테이블 중 하나의 끝에 도달할 때까지 이 과정을 반복합니다.

*(이미지: 정렬된 두 테이블을 순차적으로 병합하는 과정)*

### 2\. 성능 및 특징

- **장점**:

    - **대용량 테이블 조인** 시 중첩 루프 조인보다 성능이 우수합니다. 각 테이블을 한 번씩만 스캔하기 때문입니다.
    - \*\*동등 조인(Equi-Join)\*\*뿐만 아니라 비등가 조인(`>` , `<` 등)에서도 효율적으로 동작합니다.
    - 조인 컬럼이 이미 정렬되어 있거나 인덱스가 있을 경우 정렬 단계를 건너뛰어 매우 빠르게 처리됩니다.

- **단점**:

    - **정렬 작업의 비용이 매우 큽니다.** 데이터가 많을 경우 정렬 과정에서 많은 시간과 메모리 자원을 소모하며, 디스크 I/O가 발생할 수 있습니다.
    - 결과를 얻기 전에 전체 정렬 작업이 끝나야 하므로, 첫 번째 결과를 보기까지의 대기 시간이 길 수 있습니다.

### 3\. 예시

다음과 같은 SQL 쿼리가 있을 때, 데이터베이스 옵티마이저는 정렬 병합 조인을 선택할 수 있습니다.

```sql
SELECT *
FROM LARGE_TABLE_A A
JOIN LARGE_TABLE_B B ON A.ID = B.ID;
```

- **옵티마이저의 판단**: `LARGE_TABLE_A`와 `LARGE_TABLE_B`가 모두 대용량이고, `A.ID`나 `B.ID` 컬럼에 적절한 인덱스가 없어 중첩 루프 조인이 비효율적이라고 판단할 경우 정렬 병합 조인을 선택합니다.
- **실행 과정**:
    1.  **정렬**: `LARGE_TABLE_A`를 `ID` 기준으로 정렬하고, `LARGE_TABLE_B`도 `ID` 기준으로 정렬합니다.
    2.  **병합**: 정렬된 두 테이블을 처음부터 스캔하며 `ID` 값이 같은 데이터를 찾아 결과 집합에 추가합니다.