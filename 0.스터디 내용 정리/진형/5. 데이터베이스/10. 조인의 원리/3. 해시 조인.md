## 데이터베이스 조인 방식: 해시 조인 (Hash Join)

\*\*해시 조인(Hash Join)\*\*은 두 테이블을 조인할 때 \*\*해시 테이블(Hash Table)\*\*이라는 메모리 구조를 사용하는 방식입니다. 이 방식은 \*\*동등 조인(Equi-Join, `=` 조건)\*\*에서만 사용할 수 있으며, 정렬이나 인덱스가 없는 **대용량 테이블을 조인할 때 가장 뛰어난 성능**을 보입니다.

중첩 루프 조인이나 정렬 병합 조인과는 완전히 다른 방식으로 동작하며, 두 조인 방식이 비효율적일 때 옵티마이저가 주로 선택하는 최종 수단입니다.

### 1\. 동작 원리

해시 조인은 **빌드(Build) 단계**와 **프로브(Probe) 단계**라는 두 가지 명확한 단계로 나뉩니다.

#### 1단계: 빌드 (Build Phase)

1.  두 테이블 중 **더 작은 테이블**을 선택하여 \*\*빌드 테이블(Build Table)\*\*로 지정합니다.
2.  빌드 테이블의 **조인 컬럼 값을 해시 함수(Hash Function)에 적용**하여 해시 값을 계산합니다.
3.  계산된 해시 값을 주소(Key)로 사용하여 **메모리에 해시 테이블을 생성**하고, 해당 행의 데이터를 저장합니다. 이 과정은 빌드 테이블의 모든 행에 대해 반복됩니다.

> **해시 테이블이란?**
> Key-Value 형태로 데이터를 저장하는 자료구조입니다. 특정 Key를 통해 원하는 Value를 매우 빠르게(평균적으로 O(1) 시간 복잡도) 찾아낼 수 있습니다.

#### 2단계: 프로브 (Probe Phase)

1.  나머지 **더 큰 테이블**을 \*\*프로브 테이블(Probe Table)\*\*로 지정합니다.
2.  프로브 테이블의 행을 순서대로 하나씩 읽으면서, **조인 컬럼 값을 빌드 단계에서 사용한 것과 동일한 해시 함수에 적용**하여 해시 값을 계산합니다.
3.  계산된 해시 값을 가지고 메모리에 생성된 \*\*해시 테이블에서 일치하는 값이 있는지 탐색(Probe)\*\*합니다.
4.  해시 테이블에서 동일한 해시 값을 가진 행을 찾으면, 실제 조인 컬럼 값이 같은지 한 번 더 확인한 후(해시 충돌 방지), 결과 집합에 추가합니다.

*(이미지: 작은 테이블로 해시 테이블을 만들고(Build), 큰 테이블로 탐색하는(Probe) 과정)*

### 2\. 성능 및 특징

- **장점**:

    - **대용량, 비정렬 데이터**의 동등 조인에서 가장 좋은 성능을 보입니다. 정렬 과정이 필요 없고, 인덱스의 유무에도 영향을 받지 않습니다.
    - 각 테이블을 한 번만 읽고 처리하므로 I/O 비용이 적습니다.

- **단점**:

    - **오직 동등 조인(`=`)에서만 사용 가능**합니다. `BETWEEN`, `>`, `<` 같은 비등가 조인에서는 사용할 수 없습니다.
    - 해시 테이블을 메모리에 생성해야 하므로 **상대적으로 많은 메모리 공간을 사용**합니다. 해시 테이블이 메모리에 모두 들어가지 못할 경우, 디스크를 사용하게 되어 성능이 급격히 저하될 수 있습니다.
    - 전체 결과를 반환하기 전에 해시 테이블 생성(Build Phase)이 완료되어야 하므로, 첫 번째 결과를 보기까지의 대기 시간이 길 수 있습니다.

### 3\. 예시

다음과 같은 SQL 쿼리가 있을 때, 데이터베이스 옵티마이저는 해시 조인을 선택할 수 있습니다.

```sql
SELECT *
FROM SALES S           -- 대용량 테이블 (예: 1억 건)
JOIN PRODUCTS P ON S.PRODUCT_ID = P.PRODUCT_ID; -- 상대적으로 작은 테이블 (예: 1만 건)
```

- **옵티마이저의 판단**: `SALES`와 `PRODUCTS` 테이블이 모두 크고, 조인 컬럼에 적절한 인덱스가 없으며, 동등 조인 조건을 만족하므로 해시 조인을 선택합니다.
- **실행 과정**:
    1.  **빌드(Build)**: 더 작은 테이블인 `PRODUCTS`를 빌드 테이블로 선택합니다. `PRODUCTS` 테이블의 모든 행에 대해 `PRODUCT_ID`를 해시 함수에 적용하여 메모리에 해시 테이블을 생성합니다.
    2.  **프로브(Probe)**: 더 큰 테이블인 `SALES`를 프로브 테이블로 선택합니다. `SALES` 테이블의 모든 행을 하나씩 읽으면서 `PRODUCT_ID`를 동일한 해시 함수에 적용하고, 생성된 해시 테이블에 일치하는 데이터가 있는지 탐색하여 조인 결과를 반환합니다.