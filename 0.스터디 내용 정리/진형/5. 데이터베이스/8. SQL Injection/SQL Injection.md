# SQL Injection

## 1\. 개요

### 1.1 SQL Injection 이란?

> **SQL Injection**이란 악의적인 사용자가 보안상의 취약점을 이용하여, 임의의 SQL 문을 주입하고 실행되게 하여 데이터베이스가 비정상적인 동작을 하도록 조작하는 행위입니다. 인젝션 공격은 **OWASP Top 10** 중 최상위권에 속해 있으며, 공격이 비교적 쉬운 편이고 공격에 성공할 경우 큰 피해를 입힐 수 있는 공격입니다.

### 1.2 관련 사례: 여기어때 해킹 사건

2017년 3월에 일어난 \*\*“여기어때”\*\*의 대규모 개인정보 유출 사건도 SQL Injection 공격으로 인해 발생한 대표적인 사례입니다.

-----

## 2\. 공격 종류 및 방법

### 2.1 Error based SQL Injection (논리적 에러 이용)

가장 많이 쓰이고 대중적인 공격 기법으로, WHERE 절의 조건을 항상 참(True)으로 만들어 인증을 우회하는 방식입니다.

* **공격 원리**
  일반적으로 로그인 시 사용되는 아래와 같은 SQL 구문에서 입력값 검증이 없을 경우 공격이 발생합니다.

  ```sql
  SELECT * FROM Users WHERE id='[INPUT_ID]' AND pw='[INPUT_PW]';
  ```

* **공격 예시**
  공격자가 ID 또는 PW 입력값에 `' OR 1=1 --` 와 같은 구문을 주입합니다.

    1.  **`'`**: 앞에 있는 싱글쿼터(`'`)를 닫아 구문을 완성합니다.
    2.  **`OR 1=1`**: WHERE 절의 조건을 무조건 참(True)으로 만듭니다.
    3.  **`--`**: 뒤에 오는 나머지 쿼리문을 주석 처리하여 무시하게 만듭니다.

  **최종 실행 쿼리:**

  ```sql
  SELECT * FROM Users WHERE id='' OR 1=1 --' AND pw='...';
  ```

  이 공격으로 `Users` 테이블의 모든 데이터가 조회 조건에 부합하게 되어, 보통 가장 먼저 생성된 관리자(admin) 계정으로 로그인이 성공하게 됩니다. 관리자 권한을 탈취한 공격자는 이를 통해 2차 피해를 발생시킬 수 있습니다.

### 2.2 Union based SQL Injection

`UNION` 키워드를 사용하여 정상적인 쿼리 결과에 공격자가 원하는 다른 테이블의 데이터를 병합하여 탈취하는 공격 기법입니다.

* **공격 조건**

    1.  원본 쿼리의 결과와 `UNION`으로 합칠 쿼리의 **컬럼 수가 같아야** 합니다.
    2.  대응되는 컬럼끼리 **데이터 형이 같거나 유사해야** 합니다.

* **공격 예시**
  게시글 제목을 검색하는 쿼리문에 다음과 같은 악의적인 입력값을 주입합니다.

  **원본 쿼리:**

  ```sql
  SELECT title, contents FROM Board WHERE title LIKE '%[SEARCH_KEYWORD]%';
  ```

  **주입 구문:**

  ```
  %' UNION SELECT user_id, user_pw FROM User_Info --
  ```

  **최종 실행 쿼리:**

  ```sql
  SELECT title, contents FROM Board WHERE title LIKE '%%' UNION SELECT user_id, user_pw FROM User_Info --%';
  ```

  이 공격이 성공하면, 게시글 목록에 `User_Info` 테이블의 사용자 ID와 패스워드 정보가 함께 출력되어 개인정보가 유출됩니다.

### 2.3 Blind SQL Injection

데이터베이스의 응답 결과가 직접 보이지 않을 때, 서버의 반응(참/거짓 또는 응답 시간 차이)을 통해 정보를 유추해내는 공격 기법입니다.

#### Boolean based SQL Injection

서버의 응답이 참(True)일 때와 거짓(False)일 때 다르게 나타나는 점을 이용합니다. (예: '로그인 성공' / '로그인 실패' 메시지)

* **공격 예시 (MySQL 기준)**
  로그인 폼에 아래와 같은 구문을 주입하여 데이터베이스의 테이블명을 한 글자씩 알아냅니다.

  ```sql
  ' AND ASCII(SUBSTR((SELECT name FROM information_schema.tables LIMIT 0,1), 1, 1)) > 100 --
  ```

    1.  `SELECT name FROM ...`: DB의 첫 번째 테이블 이름을 조회합니다.
    2.  `SUBSTR(..., 1, 1)`: 조회된 이름의 첫 번째 글자를 추출합니다.
    3.  `ASCII(...)`: 추출된 글자를 아스키코드 숫자로 변환합니다.
    4.  `> 100`: 변환된 아스키코드 값을 숫자 100과 비교합니다.

  이후 로그인 성공/실패 여부에 따라 숫자 `100`을 바꿔가며 반복적으로 시도하면, 자동화 스크립트를 통해 단시간 내에 테이블 전체 이름을 알아낼 수 있습니다.

#### Time based SQL Injection

쿼리 조건의 참/거짓 결과에 따라 `SLEEP()` 이나 `BENCHMARK()` 같은 함수를 이용해 서버의 응답 시간을 의도적으로 지연시킵니다. 응답 시간의 차이로 정보를 유추합니다.

* **공격 예시 (MySQL 기준)**
  데이터베이스 이름의 길이를 알아내기 위해 아래 구문을 주입합니다.

  ```sql
  ' OR (LENGTH(DATABASE()) = 1 AND SLEEP(2)) --
  ```

    * `LENGTH(DATABASE()) = 1`이 참이면, `SLEEP(2)`가 실행되어 서버 응답이 2초간 지연됩니다.
    * 거짓이면, `SLEEP(2)`는 실행되지 않아 즉시 응답합니다.

  공격자는 숫자 `1`을 1씩 증가시키며 서버 응답이 지연되는 지점을 찾아 데이터베이스 이름의 길이를 알아낼 수 있습니다.

### 2.4 Stored Procedure SQL Injection

데이터베이스에 미리 정의된 함수 모음인 저장 프로시저(Stored Procedure)를 악용하는 공격입니다.

* MS-SQL의 `xp_cmdshell`과 같은 시스템 명령어를 실행할 수 있는 프로시저를 통해 공격이 이루어집니다.
* 공격 성공 시 서버에 직접적인 피해를 입힐 수 있으나, 시스템 권한 획득 등 사전 조건이 필요하여 공격 난이도는 높은 편입니다.

### 2.5 Mass SQL Injection

한 번의 공격으로 다수의 데이터베이스를 동시에 조작하여 큰 피해를 입히는 공격 기법입니다.

* 2008년에 처음 발견되었으며, 주로 MS-SQL을 사용하는 ASP 기반 웹 애플리케이션이 공격 대상이 됩니다.
* 공격자는 HEX 인코딩된 악성 스크립트를 데이터베이스에 삽입합니다.
* 이후 변조된 사이트에 접속하는 사용자 PC를 좀비 PC로 감염시켜 DDoS 공격 등에 악용합니다.